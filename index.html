
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>站桩禅院 - 每日精进</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f4; color: #444; }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e7e5e4; border-radius: 10px; }
    </style>

    <script>
        // 关键：必须在加载其他 JS 之前模拟 process 对象
        window.process = { env: { API_KEY: "" } };
    </script>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai@1.3.0",
    "lucide-react": "https://esm.sh/lucide-react@0.475.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root">
        <div class="min-h-screen flex items-center justify-center bg-stone-50">
            <div class="text-center">
                <div class="inline-block w-10 h-10 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-stone-400 font-serif-sc tracking-widest">正在开启禅院...</p>
            </div>
        </div>
    </div>
    
    <script type="text/babel" data-presets="react,typescript">
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";
        import { 
          Play, Pause, RotateCcw, Settings, Wind, Award, 
          CheckCircle2, Volume2, VolumeX, BookOpen, Calendar, 
          Download, Share2 
        } from 'lucide-react';

        // --- 类型与常量 ---
        const TIMER_STATUS = { IDLE: 'IDLE', RUNNING: 'RUNNING', PAUSED: 'PAUSED', COMPLETED: 'COMPLETED' };

        // --- AI 服务 ---
        const ai = new GoogleGenAI({ apiKey: window.process.env.API_KEY });

        const fetchZenWisdom = async () => {
          try {
            if (!window.process.env.API_KEY) throw new Error("Key Missing");
            const response = await ai.models.generateContent({
              model: "gemini-3-flash-preview",
              contents: "Generate a short Zen quote in Chinese for a Zhan Zhuang practitioner and a posture tip.",
              config: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    quote: { type: Type.STRING },
                    author: { type: Type.STRING },
                    advice: { type: Type.STRING }
                  },
                  required: ["quote", "author", "advice"]
                }
              }
            });
            return JSON.parse(response.text);
          } catch (e) {
            return { quote: "万缘放下，一念不生。", author: "古德", advice: "两足平开，膝微屈，含胸拔背。" };
          }
        };

        const fetchBlessing = async (mins) => {
          try {
            if (!window.process.env.API_KEY) throw new Error("Key Missing");
            const response = await ai.models.generateContent({
              model: "gemini-3-flash-preview",
              contents: `User finished ${mins} mins of standing meditation. Generate a 4-char title and blessing.`,
              config: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: { title: { type: Type.STRING }, message: { type: Type.STRING } },
                  required: ["title", "message"]
                }
              }
            });
            return JSON.parse(response.text);
          } catch (e) {
            return { title: "气色红润", message: "此时此刻，你与天地同频。" };
          }
        };

        // --- 组件 ---
        const CircularTimer = ({ timeLeft, totalTime }) => {
          const radius = 120;
          const circumference = 2 * Math.PI * radius;
          const progress = totalTime > 0 ? timeLeft / totalTime : 0;
          const offset = circumference * (1 - progress);

          const formatTime = (s) => {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
          };

          return (
            <div className="relative flex items-center justify-center w-64 h-64 md:w-80 md:h-80">
              <svg className="w-full h-full -rotate-90">
                <circle className="text-stone-200" strokeWidth="8" stroke="currentColor" fill="transparent" r={radius} cx="50%" cy="50%" />
                <circle className="text-emerald-600 transition-all duration-1000 ease-linear" strokeWidth="8" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" stroke="currentColor" fill="transparent" r={radius} cx="50%" cy="50%" />
              </svg>
              <div className="absolute flex flex-col items-center">
                <span className="text-5xl md:text-6xl font-light text-stone-800 font-serif-sc">{formatTime(timeLeft)}</span>
                <p className="text-xs text-stone-400 mt-2 tracking-[0.2em] uppercase">{timeLeft > 0 ? "入静" : "出定"}</p>
              </div>
            </div>
          );
        };

        const App = () => {
          const [status, setStatus] = useState(TIMER_STATUS.IDLE);
          const [duration, setDuration] = useState(600); // 10 mins
          const [timeLeft, setTimeLeft] = useState(600);
          const [wisdom, setWisdom] = useState(null);
          const [history, setHistory] = useState([]);
          const [showSettings, setShowSettings] = useState(false);
          const [blessing, setBlessing] = useState(null);
          const [modalOpen, setModalOpen] = useState(false);
          
          const timerRef = useRef(null);

          useEffect(() => {
            fetchZenWisdom().then(setWisdom);
            const saved = localStorage.getItem('zhan_history');
            if (saved) setHistory(JSON.parse(saved));
          }, []);

          const streak = useMemo(() => {
            if (!history.length) return 0;
            const dates = Array.from(new Set(history.map(h => h.date))).sort().reverse();
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            if (dates[0] !== today && dates[0] !== yesterday) return 0;
            let count = 0;
            let current = dates[0] === today ? today : yesterday;
            for (const d of dates) {
              if (d === current) {
                count++;
                current = new Date(new Date(current).getTime() - 86400000).toISOString().split('T')[0];
              } else break;
            }
            return count;
          }, [history]);

          useEffect(() => {
            if (status === TIMER_STATUS.RUNNING && timeLeft > 0) {
              timerRef.current = setInterval(() => setTimeLeft(t => t - 1), 1000);
            } else if (timeLeft === 0 && status === TIMER_STATUS.RUNNING) {
              handleComplete();
            }
            return () => clearInterval(timerRef.current);
          }, [status, timeLeft]);

          const handleComplete = async () => {
            setStatus(TIMER_STATUS.COMPLETED);
            const today = new Date().toISOString().split('T')[0];
            const newHistory = [{ id: Date.now(), duration, date: today }, ...history];
            setHistory(newHistory);
            localStorage.setItem('zhan_history', JSON.stringify(newHistory));
            const b = await fetchBlessing(Math.floor(duration / 60));
            setBlessing(b);
            setModalOpen(true);
          };

          return (
            <div className="min-h-screen flex flex-col bg-[#f5f5f4]">
              <header className="px-6 py-4 flex justify-between items-center bg-white/50 backdrop-blur-md sticky top-0 z-30 border-b border-stone-100">
                <div className="flex items-center space-x-3">
                  <div className="w-9 h-9 bg-emerald-700 rounded-lg flex items-center justify-center shadow-lg"><Wind className="text-white" size={20} /></div>
                  <h1 className="text-lg font-serif-sc font-bold tracking-tight">站桩禅院</h1>
                </div>
                <div className="flex items-center space-x-3">
                  <div className="bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100 flex items-center space-x-1">
                    <Award size={14} className="text-emerald-700" /><span className="text-xs font-bold text-emerald-800">{streak} 天连修</span>
                  </div>
                  <button onClick={() => setShowSettings(!showSettings)} className="p-2 text-stone-400 hover:bg-white rounded-full transition-colors"><Settings size={20} /></button>
                </div>
              </header>

              <main className="flex-1 flex flex-col items-center justify-center p-4">
                {wisdom && (
                  <div className="max-w-md text-center mb-12 px-6">
                    <p className="text-xl font-serif-sc text-stone-700 leading-relaxed italic">「{wisdom.quote}」</p>
                    <p className="text-[10px] text-stone-400 mt-3 tracking-[0.3em]">— {wisdom.author}</p>
                  </div>
                )}
                
                <CircularTimer timeLeft={timeLeft} totalTime={duration} />

                <div className="mt-12 flex items-center space-x-10">
                  <button onClick={() => { setStatus(TIMER_STATUS.IDLE); setTimeLeft(duration); }} className="p-4 bg-white shadow-sm border border-stone-100 rounded-2xl text-stone-300 hover:text-stone-500 transition-all"><RotateCcw size={22} /></button>
                  {status === TIMER_STATUS.RUNNING ? (
                    <button onClick={() => setStatus(TIMER_STATUS.PAUSED)} className="w-20 h-20 bg-emerald-700 text-white rounded-[2rem] shadow-xl shadow-emerald-100 flex items-center justify-center hover:scale-105 active:scale-95 transition-all"><Pause size={32} /></button>
                  ) : (
                    <button onClick={() => setStatus(TIMER_STATUS.RUNNING)} disabled={timeLeft === 0} className="w-20 h-20 bg-emerald-700 text-white rounded-[2rem] shadow-xl shadow-emerald-100 flex items-center justify-center disabled:bg-stone-200 hover:scale-105 active:scale-95 transition-all"><Play size={32} fill="currentColor" className="ml-1" /></button>
                  )}
                  <button className="p-4 bg-white shadow-sm border border-stone-100 rounded-2xl text-stone-300"><VolumeX size={22} /></button>
                </div>

                {showSettings && (
                  <div className="mt-8 max-w-sm w-full bg-white p-6 rounded-3xl shadow-xl border border-stone-50 animate-in zoom-in-95 duration-200">
                    <div className="flex justify-between mb-4"><h3 className="text-xs font-bold text-stone-400 tracking-widest uppercase">修行时长</h3><span className="text-emerald-700 font-bold">{duration/60} 分钟</span></div>
                    <input type="range" min="1" max="120" value={duration/60} onChange={(e) => {
                      const v = parseInt(e.target.value) * 60;
                      setDuration(v); if (status === TIMER_STATUS.IDLE) setTimeLeft(v);
                    }} className="w-full h-1.5 bg-stone-100 rounded-lg appearance-none cursor-pointer accent-emerald-700" />
                  </div>
                )}
              </main>

              <footer className="w-full max-w-4xl mx-auto px-6 py-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white p-6 rounded-3xl border border-stone-100 shadow-sm">
                    <div className="flex items-center space-x-3 mb-3 text-emerald-700"><BookOpen size={18} /><h4 className="font-bold text-stone-800">修行要领</h4></div>
                    <p className="text-sm text-stone-500 leading-relaxed">{wisdom?.advice || "意守丹田，周身放松。"}</p>
                </div>
                <div className="bg-white p-6 rounded-3xl border border-stone-100 shadow-sm">
                    <div className="flex items-center space-x-3 mb-3 text-stone-400"><Calendar size={18} /><h4 className="font-bold text-stone-800">最近日志</h4></div>
                    <div className="space-y-2 text-xs">
                        {history.length > 0 ? history.slice(0, 3).map(h => (
                            <div key={h.id} className="flex justify-between text-stone-500 border-b border-stone-50 pb-1"><span>{h.date}</span><span className="font-bold text-emerald-700">{Math.floor(h.duration/60)} 分钟</span></div>
                        )) : <p className="italic text-stone-300">尚未留下足迹</p>}
                    </div>
                </div>
              </footer>

              {modalOpen && blessing && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-stone-900/40 backdrop-blur-sm">
                  <div className="bg-white max-w-sm w-full rounded-[2.5rem] shadow-2xl p-10 text-center animate-in zoom-in-95 duration-500">
                    <div className="w-16 h-16 bg-emerald-100 text-emerald-700 rounded-full flex items-center justify-center mx-auto mb-6"><CheckCircle2 size={32} /></div>
                    <h2 className="text-3xl font-serif-sc font-bold mb-4 text-stone-800">{blessing.title}</h2>
                    <p className="text-stone-500 italic mb-8 leading-relaxed">“{blessing.message}”</p>
                    <button onClick={() => setModalOpen(false)} className="w-full py-4 bg-emerald-700 text-white rounded-2xl font-bold shadow-lg shadow-emerald-200 active:scale-95 transition-all">收功</button>
                  </div>
                </div>
              )}
            </div>
          );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
